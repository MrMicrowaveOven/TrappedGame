<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <script type="text/javascript" src='./grid.js'>
    </script>
    <script type="text/javascript" src='./box.js'>
    </script>

    <title>Trapped</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background:url(lab.jpg); background-size: 100% 100%; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="720" height="480"></canvas>

<script>

// Canvas
  var canvas = document.getElementById("myCanvas");
  var ctx = canvas.getContext("2d");

  var clickX;
  var clickY;
  var thetile;

  var grid = new Grid();
  var box = new Box();
  var allBoxes = [];

  var emptyTileColor = "darkblue";
  var filledTileColor = "red";
  var gridBorderColor = "black";
  var boxBorderColor = "black";

  allBoxes.push(box);
  // var box2 = new Box();

  // function draw() {
  //   box.dropBox();
  // }

  function dropOneBox(thebox) {
    killKey = setInterval(function(){
      dropping(thebox, killKey)
    } , 10);
  };

  function dropping(whichbox, killKey) {
    whichbox.dropBox(killKey);
  }

  dropOneBox(box);

  var gridX = 50;
  var gridY = 50;
  var gridWidth = 400;
  var gridHeight = 400;

  grid.drawGrid(gridX, gridY, gridWidth, gridHeight);
  // setInterval(draw, 10);

  canvas.addEventListener("mousedown", doMouseDown, false);

  function doMouseDown(event) {


    clickX = event.pageX - canvas.offsetLeft;
    clickY = event.pageY - canvas.offsetTop;



    if (clickX > gridX && clickY > gridY && clickX < gridX + gridWidth && clickY < gridY + gridHeight) {
      thetile = whichtileClicked(clickX, clickY);
      if (thetile !== undefined) {

        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        var tileFill = boxValue;

        grid.drawtile(thetile[0], thetile[1], thetile[2], thetile[3], "red")
        ctx.fillStyle = "black";
        ctx.fillText(tileFill, thetile[0]+thetile[2]/2, thetile[1]+thetile[3]/2);

      }
    }
  }

  function removeBox(){
    //Clear previous boxes
    allBoxes.forEach(function(box) {
      ctx.clearRect(
        box.boxStartX - 1,
        box.boxStartY - 7,
        box.widthOfBox + 2,
        box.heightOfBox + 8
      );
    });
    //Remove the one box from the queue
    var placed = allBoxes.shift();

    //Restack boxes
    allBoxes.forEach(function(box) {
      box.boxStartY += box.heightOfBox;
      box.drawBox(box.boxStartX, box.boxStartY,
        box.widthOfBox, box.heightOfBox, "red");
    });
    return placed.totalNum;
  };


  function whichtileClicked(clickX, clickY) {
    var clickedtile;
    grid.tiles.forEach(function(tile) {
      if (clickX > tile[0] && clickY > tile[1] && clickX < tile[0] + tile[2] && clickY < tile[1] + tile[3]) {
        clickedtile = tile;
        boxValue = removeBox();
      }
    })
    return clickedtile;
  }
</script>
